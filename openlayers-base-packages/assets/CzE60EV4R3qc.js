var X=Object.defineProperty;var N=t=>{throw TypeError(t)};var H=(t,e,r)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var q=(t,e,r)=>H(t,typeof e!="symbol"?e+"":e,r),A=(t,e,r)=>e.has(t)||N("Cannot "+r);var h=(t,e,r)=>(A(t,e,"read from private field"),r?r.call(t):e.get(t)),b=(t,e,r)=>e.has(t)?N("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),x=(t,e,r,s)=>(A(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r),O=(t,e,r)=>(A(t,e,"access private method"),r);import{c as Q,i as Z,r as y,j as R}from"./DnPhTJjuvB9x.js";import{G as z,T as $}from"./DDXpbECPx1AE.js";import{b as W,az as Y,b1 as ee,u as te,aZ as _,g as k,b4 as re}from"./CIxQfNC2cMTH.js";import{a as se,b as oe,c as ae}from"./CeFd-AnRDxaP.js";const ne="next";function ce(t,e,r,s){const o=new URL(t),a=o.searchParams;return a.set("bbox",e.join(",")),a.set("bbox-crs",r),a.set("crs",r),a.set("f","json"),s?.(new URL(o))??o}function ie(t,e,r){const s=new URL(t),o=s.searchParams;return o.set("offset",e.toString()),o.set("limit",r.toString()),s.toString()}function G(t){if(!Array.isArray(t))return;const r=t.filter(s=>s.rel===ne);if(r.length===1)return r[0]?.href}async function T(t,e,r,s){let o=[];const a={headers:{Accept:"application/geo+json"},signal:s},n=await r.fetch(t,a);if(n.status!==200)throw new Error(`Failed to query features from service (status code ${n.status})`);const u=await n.json();e&&(o=e.readFeatures(u));const c=G(u.links);return{features:o,numberMatched:u.numberMatched,nextURL:c}}async function ue(t,e){const r={supportsOffsetStrategy:!1},s=new URL(t);s.searchParams.set("limit","1"),s.searchParams.set("f","json");const o=await e.fetch(s.toString(),{headers:{Accept:"application/geo+json"}});if(o.status!==200)throw new Error(`Failed to probe collection information (status code ${o.status})`);const a=await o.json(),n=G(a.links);if(!n)return r;const c=new URL(n).searchParams.has("offset");return r.supportsOffsetStrategy=c,r}async function le(t){const{fullURL:e,featureFormat:r,signal:s,addFeatures:o,queryFeatures:a}=t,n=t.limit,u=t.maxConcurrentRequests;let c=0,l=e;const d=[];let i;for(;l;){let p;i==null?p=u:p=Math.ceil((i-c)/n),p=Math.max(1,Math.min(p,u));const S=[];for(let m=0;m<p;++m)S.push(ie(e,c,n)),c+=n;const f=await V(S,r,t.httpService,s,o,a);d.push(...f.features),l=f.nextURL,f.numberMatched!=null&&(i=f.numberMatched)}return d}const L=Q("ogc-features:OgcFeatureSourceFactory"),fe=5e3,me=6;function he(t,e){return de(t,{httpService:e})}function de(t,e){const r=e.httpService,s=`${t.baseUrl}/collections/${t.collectionId}/items?`,o=new W({format:new z,strategy:Y,attributions:t.attributions,...t.additionalOptions}),a=e.queryFeaturesParam??T,n=e.getCollectionInfosParam??ue,u=e.addFeaturesParam||function(i){L.debug(`Adding ${i.length} features`),o.addFeatures(i)};let c,l;const d=async(i,p,S,f,m)=>{l??=n(s,r);let F;try{F=await l}catch(w){L.error("Failed to retrieve collection information",w),m?.(),l=void 0;return}c?.abort("Extent changed"),c=new AbortController;const j=ce(s,i,t.crs,t.rewriteUrl);let C=t?.strategy||(F?.supportsOffsetStrategy?"offset":"next");C==="offset"&&!F?.supportsOffsetStrategy&&(C="next");try{const w=await ge(C,{fullURL:j.toString(),httpService:r,featureFormat:o.getFormat(),queryFeatures:a,addFeatures:u,limit:t.limit??fe,maxConcurrentRequests:t.maxConcurrentRequests??me,signal:c.signal,collectionInfos:F});f?.(w),L.debug("Finished loading features for extent:",i)}catch(w){Z(w)?(L.debug("Query-Feature-Request aborted",w),o.removeLoadedExtent(i),m?.()):L.error("Failed to load features",w)}};return o.setLoader(d),o}function ge(t,e){switch(t){case"next":return pe(e);case"offset":return le(e)}}async function pe(t){const e=t.limit;let r=new URL(t.fullURL);r.searchParams.set("limit",e.toString());let s=[];do{const o=await V([r.toString()],t.featureFormat,t.httpService,t.signal,t.addFeatures,t.queryFeatures);if(s=s.concat(o.features),!o.nextURL)break;r=new URL(o.nextURL)}while(!0);return s}async function V(t,e,r,s,o,a=T){const n={nextURL:void 0,numberMatched:void 0,features:[]},u=t.map(async(c,l)=>{const d=l===t.length-1,i=await a(c,e,r,s);o(i.features),L.debug(`NextURL for index = ${l} (isLast = ${d}): ${i.nextURL||"No Next URL"}`),n.features.push(...i.features),d&&(n.numberMatched=i.numberMatched,n.nextURL=i.nextURL)});return await Promise.all(u),n}var g,P,I,M,U,D,B;class be{constructor(e,r){b(this,U);q(this,"label");b(this,g);b(this,P);b(this,I);b(this,M);this.label=e.label,x(this,g,e),x(this,P,r);const{baseUrl:s,params:o}=xe(e.baseUrl);x(this,I,s),x(this,M,o)}async search(e,{mapProjection:r,maxResults:s,signal:o}){const a=O(this,U,B).call(this,e,s),n=new z({dataProjection:"EPSG:4326",featureProjection:r});return(await we(h(this,P),a,o)).features.map(c=>O(this,U,D).call(this,c,n))}}g=new WeakMap,P=new WeakMap,I=new WeakMap,M=new WeakMap,U=new WeakSet,D=function(e,r){const s=h(this,g).renderLabel?.(e),o=e.properties[h(this,g).labelProperty],a=e.properties[h(this,g).searchProperty],n=s||(o!==void 0?String(o):a!==void 0?String(a):"");return{id:e.id??ee(),label:n,geometry:r.readGeometry(e.geometry),properties:e.properties}},B=function(e,r){const s=new URL(`${h(this,I)}/collections/${h(this,g).collectionId}/items`);for(const[o,a]of h(this,M))s.searchParams.append(o,a);return s.searchParams.set(h(this,g).searchProperty,`*${e}*`),s.searchParams.set("limit",String(r)),s.searchParams.set("f","json"),h(this,g).rewriteUrl?.(new URL(s))??s};async function we(t,e,r){try{const s=await t.fetch(e,{signal:r,headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Request failed with status "+s.status);return await s.json()}catch(s){throw Z(s)?s:new Error("Failed to search on OGC API Features service",{cause:s})}}function xe(t){const e=new URL(t),r=new URLSearchParams(e.searchParams);return e.search="",{baseUrl:e.href.replace(/\/+$/,""),params:r}}var v;class Ie{constructor({references:e}){b(this,v);x(this,v,e.httpService)}createVectorSource(e){return he(e,h(this,v))}}v=new WeakMap;var E;class Me{constructor({references:e}){b(this,E);x(this,E,e.httpService)}createSearchSource(e){return new be(e,h(this,E))}}E=new WeakMap;const Re="@open-pioneer/map-navigation",J=te.bind(void 0,Re),ve=y.forwardRef(function(e,r){const{mapId:s}=e,{containerProps:o}=_("initial-extent",e),{map:a}=k(s),n=J();function u(){const c=a?.initialExtent,l=a?.olMap;if(c&&l){const d=[c.xMin,c.yMin,c.xMax,c.yMax];l.getView().fit(d,{duration:200})}}return R.jsx($,{ref:r,label:n.formatMessage({id:"initial-extent.title"}),icon:R.jsx(se,{}),onClick:u,...o})}),Ee=y.forwardRef(function(e,r){return R.jsx(K,{zoomDirection:"in",ref:r,...e})}),je=y.forwardRef(function(e,r){return R.jsx(K,{zoomDirection:"out",ref:r,...e})}),K=y.forwardRef(function(e,r){const{mapId:s,zoomDirection:o}=e,{map:a}=k(s),n=J(),[u,c]=y.useState(!1),{defaultClassName:l,buttonLabel:d,buttonIcon:i}=Fe(n,o),{containerProps:p}=_(re("zoom",l),e);function S(){if(u)return;c(!0);const f=a?.olMap.getView();let m=f?.getZoom();const F=f?.getMaxZoom()||Number.MAX_SAFE_INTEGER,j=f?.getMinZoom()||0;f&&m!==void 0&&(o==="in"&&m<F?++m:o==="out"&&m>j&&--m,f.animate({zoom:m,duration:200},()=>c(!1)))}return R.jsx($,{ref:r,label:d,icon:i,onClick:S,...p})});function Fe(t,e){switch(e){case"in":return{defaultClassName:"zoom-in",buttonLabel:t.formatMessage({id:"zoom-in.title"}),buttonIcon:R.jsx(ae,{})};case"out":return{defaultClassName:"zoom-out",buttonLabel:t.formatMessage({id:"zoom-out.title"}),buttonIcon:R.jsx(oe,{})}}}export{ve as I,Me as S,Ie as V,Ee as Z,je as a};
