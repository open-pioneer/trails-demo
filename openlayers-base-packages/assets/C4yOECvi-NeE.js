var X=Object.defineProperty;var O=t=>{throw TypeError(t)};var H=(t,e,r)=>e in t?X(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var N=(t,e,r)=>H(t,typeof e!="symbol"?e+"":e,r),C=(t,e,r)=>e.has(t)||O("Cannot "+r);var m=(t,e,r)=>(C(t,e,"read from private field"),r?r.call(t):e.get(t)),b=(t,e,r)=>e.has(t)?O("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,r),R=(t,e,r,s)=>(C(t,e,"write to private field"),s?s.call(t,r):e.set(t,r),r),A=(t,e,r)=>(C(t,e,"access private method"),r);import{c as Q,i as q,r as y,j as F}from"./DnPhTJjuvB9x.js";import{G as Z,T as _}from"./CuNEEs1bZnrY.js";import{b as W,aA as Y,b2 as ee,u as te,a_ as $,g as z,b5 as re}from"./Dc7aEQRB6XUM.js";import{a as se,b as oe,c as ae}from"./CeFd-AnRDxaP.js";const ne="next";function ce(t,e,r,s){const o=new URL(t),a=o.searchParams;return a.set("bbox",e.join(",")),a.set("bbox-crs",r),a.set("crs",r),a.set("f","json"),s?.(new URL(o))??o}function ie(t,e,r){const s=new URL(t),o=s.searchParams;return o.set("offset",e.toString()),o.set("limit",r.toString()),s.toString()}function k(t){if(!Array.isArray(t))return;const r=t.filter(s=>s.rel===ne);if(r.length===1)return r[0]?.href}async function G(t,e,r,s){let o=[];const a={headers:{Accept:"application/geo+json"},signal:s},n=await r.fetch(t,a);if(n.status!==200)throw new Error(`Failed to query features from service (status code ${n.status})`);const c=await n.json();e&&(o=e.readFeatures(c));const i=k(c.links);return{features:o,numberMatched:c.numberMatched,nextURL:i}}async function ue(t,e){const r={supportsOffsetStrategy:!1},s=new URL(t);s.searchParams.set("limit","1"),s.searchParams.set("f","json");const o=await e.fetch(s.toString(),{headers:{Accept:"application/geo+json"}});if(o.status!==200)throw new Error(`Failed to probe collection information (status code ${o.status})`);const a=await o.json(),n=k(a.links);if(!n)return r;const i=new URL(n).searchParams.has("offset");return r.supportsOffsetStrategy=i,r}async function le(t){const{fullURL:e,featureFormat:r,signal:s,addFeatures:o,queryFeatures:a}=t,n=t.limit,c=t.maxConcurrentRequests;let i=0,l=e;const d=[];let u;for(;l;){let p;u==null?p=c:p=Math.ceil((u-i)/n),p=Math.max(1,Math.min(p,c));const g=[];for(let w=0;w<p;++w)g.push(ie(e,i,n)),i+=n;const f=await T(g,r,t.httpService,s,o,a);d.push(...f.features),l=f.nextURL,f.numberMatched!=null&&(u=f.numberMatched)}return d}const U=Q("ogc-features:OgcFeatureSourceFactory"),fe=5e3,me=6;function he(t,e){return de(t,{httpService:e})}function de(t,e){const r=e.httpService,s=`${t.baseUrl}/collections/${t.collectionId}/items?`,o=new W({format:new Z,strategy:Y,attributions:t.attributions,...t.additionalOptions}),a=e.queryFeaturesParam??G,n=e.getCollectionInfosParam??ue,c=e.addFeaturesParam||function(u){U.debug(`Adding ${u.length} features`),o.addFeatures(u)};let i,l;const d=async(u,p,g,f,w)=>{l??=n(s,r);let L;try{L=await l}catch(x){U.error("Failed to retrieve collection information",x),w?.(),l=void 0;return}i?.abort("Extent changed"),i=new AbortController;const K=ce(s,u,t.crs,t.rewriteUrl);let j=t?.strategy||(L?.supportsOffsetStrategy?"offset":"next");j==="offset"&&!L?.supportsOffsetStrategy&&(j="next");try{const x=await ge(j,{fullURL:K.toString(),httpService:r,featureFormat:o.getFormat(),queryFeatures:a,addFeatures:c,limit:t.limit??fe,maxConcurrentRequests:t.maxConcurrentRequests??me,signal:i.signal,collectionInfos:L});f?.(x),U.debug("Finished loading features for extent:",u)}catch(x){q(x)?(U.debug("Query-Feature-Request aborted",x),o.removeLoadedExtent(u),w?.()):U.error("Failed to load features",x)}};return o.setLoader(d),o}function ge(t,e){switch(t){case"next":return pe(e);case"offset":return le(e)}}async function pe(t){const e=t.limit;let r=new URL(t.fullURL);r.searchParams.set("limit",e.toString());let s=[];do{const o=await T([r.toString()],t.featureFormat,t.httpService,t.signal,t.addFeatures,t.queryFeatures);if(s=s.concat(o.features),!o.nextURL)break;r=new URL(o.nextURL)}while(!0);return s}async function T(t,e,r,s,o,a=G){const n={nextURL:void 0,numberMatched:void 0,features:[]},c=t.map(async(i,l)=>{const d=l===t.length-1,u=await a(i,e,r,s);o(u.features),U.debug(`NextURL for index = ${l} (isLast = ${d}): ${u.nextURL||"No Next URL"}`),n.features.push(...u.features),d&&(n.numberMatched=u.numberMatched,n.nextURL=u.nextURL)});return await Promise.all(c),n}var h,P,I,M,S,V,D;class be{constructor(e,r){b(this,S);N(this,"label");b(this,h);b(this,P);b(this,I);b(this,M);this.label=e.label,R(this,h,e),R(this,P,r);const{baseUrl:s,params:o}=xe(e.baseUrl);R(this,I,s),R(this,M,o)}async search(e,{mapProjection:r,maxResults:s,signal:o}){const a=A(this,S,D).call(this,e,s),n=new Z({dataProjection:"EPSG:4326",featureProjection:r});return(await we(m(this,P),a,o)).features.map(i=>A(this,S,V).call(this,i,n))}}h=new WeakMap,P=new WeakMap,I=new WeakMap,M=new WeakMap,S=new WeakSet,V=function(e,r){const s=m(this,h).renderLabel?.(e),o=e.properties[m(this,h).labelProperty],a=e.properties[m(this,h).searchProperty],n=s||(o!==void 0?String(o):a!==void 0?String(a):"");return{id:e.id??ee(),label:n,geometry:r.readGeometry(e.geometry),properties:e.properties}},D=function(e,r){const s=new URL(`${m(this,I)}/collections/${m(this,h).collectionId}/items`);for(const[o,a]of m(this,M))s.searchParams.append(o,a);return s.searchParams.set(m(this,h).searchProperty,`*${e}*`),s.searchParams.set("limit",String(r)),s.searchParams.set("f","json"),m(this,h).rewriteUrl?.(new URL(s))??s};async function we(t,e,r){try{const s=await t.fetch(e,{signal:r,headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Request failed with status "+s.status);return await s.json()}catch(s){throw q(s)?s:new Error("Failed to search on OGC API Features service",{cause:s})}}function xe(t){const e=new URL(t),r=new URLSearchParams(e.searchParams);return e.search="",{baseUrl:e.href.replace(/\/+$/,""),params:r}}var v;class Ie{constructor({references:e}){b(this,v);R(this,v,e.httpService)}createVectorSource(e){return he(e,m(this,v))}}v=new WeakMap;var E;class Me{constructor({references:e}){b(this,E);R(this,E,e.httpService)}createSearchSource(e){return new be(e,m(this,E))}}E=new WeakMap;const Re="@open-pioneer/map-navigation",B=te.bind(void 0,Re),ve=y.forwardRef(function(e,r){const{containerProps:s}=$("initial-extent",e),{map:o}=z(e),a=B();function n(){const c=o?.initialExtent,i=o?.olMap;if(c&&i){const l=[c.xMin,c.yMin,c.xMax,c.yMax];i.getView().fit(l,{duration:200})}}return F.jsx(_,{ref:r,label:a.formatMessage({id:"initial-extent.title"}),icon:F.jsx(se,{}),onClick:n,...s})}),Ee=y.forwardRef(function(e,r){return F.jsx(J,{zoomDirection:"in",ref:r,...e})}),je=y.forwardRef(function(e,r){return F.jsx(J,{zoomDirection:"out",ref:r,...e})}),J=y.forwardRef(function(e,r){const{zoomDirection:s}=e,{map:o}=z(e),a=B(),[n,c]=y.useState(!1),{defaultClassName:i,buttonLabel:l,buttonIcon:d}=Fe(a,s),{containerProps:u}=$(re("zoom",i),e);function p(){if(n)return;c(!0);const g=o?.olMap.getView();let f=g?.getZoom();const w=g?.getMaxZoom()||Number.MAX_SAFE_INTEGER,L=g?.getMinZoom()||0;g&&f!==void 0&&(s==="in"&&f<w?++f:s==="out"&&f>L&&--f,g.animate({zoom:f,duration:200},()=>c(!1)))}return F.jsx(_,{ref:r,label:l,icon:d,onClick:p,...u})});function Fe(t,e){switch(e){case"in":return{defaultClassName:"zoom-in",buttonLabel:t.formatMessage({id:"zoom-in.title"}),buttonIcon:F.jsx(ae,{})};case"out":return{defaultClassName:"zoom-out",buttonLabel:t.formatMessage({id:"zoom-out.title"}),buttonIcon:F.jsx(oe,{})}}}export{ve as I,Me as S,Ie as V,Ee as Z,je as a};
