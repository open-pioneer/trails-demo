import{aQ as K,a as P,aW as V,br as U,cl as L,bp as D,p as v,aA as k}from"./c8e5ac35263a.js";function O(r,e){const n=[];Object.keys(e).forEach(function(s){e[s]!==null&&e[s]!==void 0&&n.push(s+"="+encodeURIComponent(e[s]))});const i=n.join("&");return r=r.replace(/[?&]$/,""),r+=r.includes("?")?"&":"?",r+i}class q extends K{constructor(e){super({extent:e.extent,origin:e.origin,origins:e.origins,resolutions:e.resolutions,tileSize:e.tileSize,tileSizes:e.tileSizes,sizes:e.sizes}),this.matrixIds_=e.matrixIds}getMatrixId(e){return this.matrixIds_[e]}getMatrixIds(){return this.matrixIds_}}const B=q;function X(r,e,n){const i=[],s=[],o=[],f=[],h=[];n=n!==void 0?n:[];const E="SupportedCRS",m="TileMatrix",c="Identifier",C="ScaleDenominator",u="TopLeftCorner",T="TileWidth",F="TileHeight",I=r[E],b=P(I),x=b.getMetersPerUnit(),g=b.getAxisOrientation().substr(0,2)=="ne";return r[m].sort(function(a,S){return S[C]-a[C]}),r[m].forEach(function(a){let S;if(n.length>0?S=n.find(function(_){return a[c]==_[m]?!0:a[c].includes(":")?!1:r[c]+":"+a[c]===_[m]}):S=!0,S){s.push(a[c]);const _=a[C]*28e-5/x,j=a[T],d=a[F];g?o.push([a[u][1],a[u][0]]):o.push(a[u]),i.push(_),f.push(j==d?j:[j,d]),h.push([a.MatrixWidth,a.MatrixHeight])}}),new q({extent:e,origins:o,resolutions:i,matrixIds:s,tileSizes:f,sizes:h})}class H extends V{constructor(e){const n=e.requestEncoding!==void 0?e.requestEncoding:"KVP",i=e.tileGrid;let s=e.urls;s===void 0&&e.url!==void 0&&(s=U(e.url)),super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:e.tileClass,tileGrid:i,tileLoadFunction:e.tileLoadFunction,tilePixelRatio:e.tilePixelRatio,urls:s,wrapX:e.wrapX!==void 0?e.wrapX:!1,transition:e.transition,zDirection:e.zDirection}),this.version_=e.version!==void 0?e.version:"1.0.0",this.format_=e.format!==void 0?e.format:"image/jpeg",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,this.matrixSet_=e.matrixSet,this.style_=e.style,this.requestEncoding_=n,this.setKey(this.getKeyForDimensions_()),s&&s.length>0&&(this.tileUrlFunction=L(s.map(this.createFromWMTSTemplate.bind(this))))}setUrls(e){this.urls=e;const n=e.join(`
`);this.setTileUrlFunction(L(e.map(this.createFromWMTSTemplate.bind(this))),n)}getDimensions(){return this.dimensions_}getFormat(){return this.format_}getLayer(){return this.layer_}getMatrixSet(){return this.matrixSet_}getRequestEncoding(){return this.requestEncoding_}getStyle(){return this.style_}getVersion(){return this.version_}getKeyForDimensions_(){const e=this.urls?this.urls.slice(0):[];for(const n in this.dimensions_)e.push(n+"-"+this.dimensions_[n]);return e.join("/")}updateDimensions(e){Object.assign(this.dimensions_,e),this.setKey(this.getKeyForDimensions_())}createFromWMTSTemplate(e){const n=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};n=="KVP"&&Object.assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=n=="KVP"?O(e,i):e.replace(/\{(\w+?)\}/g,function(f,h){return h.toLowerCase()in i?i[h.toLowerCase()]:f});const s=this.tileGrid,o=this.dimensions_;return function(f,h,E){if(!f)return;const m={TileMatrix:s.getMatrixId(f[0]),TileCol:f[1],TileRow:f[2]};Object.assign(m,o);let c=e;return n=="KVP"?c=O(c,m):c=c.replace(/\{(\w+?)\}/g,function(C,u){return m[u]}),c}}}const A=H;function Y(r,e){const i=r.Contents.Layer.find(function(t){return t.Identifier==e.layer});if(!i)return null;const s=r.Contents.TileMatrixSet;let o;i.TileMatrixSetLink.length>1?"projection"in e?o=i.TileMatrixSetLink.findIndex(function(t){const y=s.find(function(w){return w.Identifier==t.TileMatrixSet}).SupportedCRS,G=P(y),p=P(e.projection);return G&&p?D(G,p):y==e.projection}):o=i.TileMatrixSetLink.findIndex(function(t){return t.TileMatrixSet==e.matrixSet}):o=0,o<0&&(o=0);const f=i.TileMatrixSetLink[o].TileMatrixSet,h=i.TileMatrixSetLink[o].TileMatrixSetLimits;let E=i.Format[0];"format"in e&&(E=e.format),o=i.Style.findIndex(function(t){return"style"in e?t.Title==e.style:t.isDefault}),o<0&&(o=0);const m=i.Style[o].Identifier,c={};"Dimension"in i&&i.Dimension.forEach(function(t,l,y){const G=t.Identifier;let p=t.Default;p===void 0&&(p=t.Value[0]),c[G]=p});const u=r.Contents.TileMatrixSet.find(function(t){return t.Identifier==f});let T;const F=u.SupportedCRS;if(F&&(T=P(F)),"projection"in e){const t=P(e.projection);t&&(!T||D(t,T))&&(T=t)}let I=!1;const b=T.getAxisOrientation().substr(0,2)=="ne";let x=u.TileMatrix[0],g={MinTileCol:0,MinTileRow:0,MaxTileCol:x.MatrixWidth-1,MaxTileRow:x.MatrixHeight-1};if(h){g=h[h.length-1];const t=u.TileMatrix.find(l=>l.Identifier===g.TileMatrix||u.Identifier+":"+l.Identifier===g.TileMatrix);t&&(x=t)}const a=x.ScaleDenominator*28e-5/T.getMetersPerUnit(),S=b?[x.TopLeftCorner[1],x.TopLeftCorner[0]]:x.TopLeftCorner,_=x.TileWidth*a,j=x.TileHeight*a;let d=u.BoundingBox;d&&b&&(d=[d[1],d[0],d[3],d[2]]);let W=[S[0]+_*g.MinTileCol,S[1]-j*(1+g.MaxTileRow),S[0]+_*(1+g.MaxTileCol),S[1]-j*g.MinTileRow];if(d!==void 0&&!v(d,W)){const t=i.WGS84BoundingBox,l=P("EPSG:4326").getExtent();if(W=d,t)I=t[0]===l[0]&&t[2]===l[2];else{const y=k(d,u.SupportedCRS,"EPSG:4326");I=y[0]-1e-10<=l[0]&&y[2]+1e-10>=l[2]}}const z=X(u,W,h),R=[];let M=e.requestEncoding;if(M=M!==void 0?M:"","OperationsMetadata"in r&&"GetTile"in r.OperationsMetadata){const t=r.OperationsMetadata.GetTile.DCP.HTTP.Get;for(let l=0,y=t.length;l<y;++l)if(t[l].Constraint){const p=t[l].Constraint.find(function(w){return w.name=="GetEncoding"}).AllowedValues.Value;if(M===""&&(M=p[0]),M==="KVP")p.includes("KVP")&&R.push(t[l].href);else break}else t[l].href&&(M="KVP",R.push(t[l].href))}return R.length===0&&(M="REST",i.ResourceURL.forEach(function(t){t.resourceType==="tile"&&(E=t.format,R.push(t.template))})),{urls:R,layer:e.layer,matrixSet:f,format:E,projection:T,requestEncoding:M,tileGrid:z,style:m,dimensions:c,wrapX:I,crossOrigin:e.crossOrigin}}export{A as W,B as a,O as b,Y as o};
