var H=Object.defineProperty;var Q=(e,t,r)=>t in e?H(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var A=(e,t,r)=>(Q(e,typeof t!="symbol"?t+"":t,r),r),C=(e,t,r)=>{if(!t.has(e))throw TypeError("Cannot "+r)};var f=(e,t,r)=>(C(e,t,"read from private field"),r?r.call(e):t.get(e)),p=(e,t,r)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,r)},w=(e,t,r,s)=>(C(e,t,"write to private field"),s?s.call(e,r):t.set(e,r),r);var O=(e,t,r)=>(C(e,t,"access private method"),r);import{a as W,i as q,r as j,j as R}from"./7b9bf2e5ae39.js";import{G as N}from"./b32fa8931d06.js";import{z as X,br as Y,a8 as tt,ab as z}from"./a43dafd8eb62.js";import{u as $,a as k,c as et}from"./6e72ec7ae19c.js";import{a as rt,b as st,c as ot}from"./e9fe14d5121b.js";import{u as at}from"./2f6cd8ce72f0.js";const nt="next";function ct(e,t,r){const s=new URL(e),o=s.searchParams;return o.set("bbox",t.join(",")),o.set("bbox-crs",r),o.set("crs",r),o.set("f","json"),s}function it(e,t,r){const s=new URL(e),o=s.searchParams;return o.set("offset",t.toString()),o.set("limit",r.toString()),s.toString()}function Z(e){if(!Array.isArray(e))return;const r=e.filter(s=>s.rel===nt);if(r.length===1)return r[0]?.href}async function _(e,t,r,s){let o=[];const c={headers:{Accept:"application/geo+json"},signal:s},a=await r.fetch(e,c);if(a.status!==200)throw new Error(`Failed to query features from service (status code ${a.status})`);const u=await a.json();t&&(o=t.readFeatures(u));const n=Z(u.links);return{features:o,numberMatched:u.numberMatched,nextURL:n}}async function ut(e,t){const r={supportsOffsetStrategy:!1},s=new URL(e);s.searchParams.set("limit","1"),s.searchParams.set("f","json");const o=await t.fetch(s.toString(),{headers:{Accept:"application/geo+json"}});if(o.status!==200)throw new Error(`Failed to probe collection information (status code ${o.status})`);const c=await o.json(),a=Z(c.links);if(!a)return r;const n=new URL(a).searchParams.has("offset");return r.supportsOffsetStrategy=n,r}async function lt(e){const{fullURL:t,featureFormat:r,signal:s,addFeatures:o,queryFeatures:c}=e,a=e.limit,u=e.maxConcurrentRequests;let n=0,l=t;const m=[];let i;for(;l;){let h;i==null?h=u:h=Math.ceil((i-n)/a),h=Math.max(1,Math.min(h,u));const g=[];for(let L=0;L<h;++L)g.push(it(t,n,a)),n+=a;const x=await V(g,r,e.httpService,s,o,c);m.push(...x.features),l=x.nextURL,x.numberMatched!=null&&(i=x.numberMatched)}return m}const F=W("ogc-features:OgcFeatureSourceFactory"),ft=5e3,mt=6;function ht(e,t){return dt(e,{httpService:t})}function dt(e,t){const r=t.httpService,s=`${e.baseUrl}/collections/${e.collectionId}/items?`,o=new X({format:new N,strategy:Y,attributions:e.attributions,...e.additionalOptions}),c=t.queryFeaturesParam??_,a=t.getCollectionInfosParam??ut,u=t.addFeaturesParam||function(i){F.debug(`Adding ${i.length} features`),o.addFeatures(i)};let n,l;const m=async(i,h,g,x,L)=>{l??=a(s,r);let E;try{E=await l}catch(b){F.error("Failed to retrieve collection information",b),L?.(),l=void 0;return}n?.abort("Extent changed"),n=new AbortController;const J=ct(s,i,e.crs),K=E?.supportsOffsetStrategy?"offset":"next";try{const b=await pt(K,{fullURL:J.toString(),httpService:r,featureFormat:o.getFormat(),queryFeatures:c,addFeatures:u,limit:e.limit??ft,maxConcurrentRequests:e.maxConcurrentRequests??mt,signal:n.signal,collectionInfos:E});x?.(b),F.debug("Finished loading features for extent:",i)}catch(b){q(b)?(F.debug("Query-Feature-Request aborted",b),o.removeLoadedExtent(i),L?.()):F.error("Failed to load features",b)}};return o.setLoader(m),o}function pt(e,t){switch(e){case"next":return gt(t);case"offset":return lt(t)}}async function gt(e){const t=e.limit;let r=new URL(e.fullURL);r.searchParams.set("limit",t.toString());let s=[];do{const o=await V([r.toString()],e.featureFormat,e.httpService,e.signal,e.addFeatures,e.queryFeatures);if(s=s.concat(o.features),!o.nextURL)break;r=new URL(o.nextURL)}while(1);return s}async function V(e,t,r,s,o,c=_){const a={nextURL:void 0,numberMatched:void 0,features:[]},u=e.map(async(n,l)=>{const m=l===e.length-1,i=await c(n,t,r,s);o(i.features),F.debug(`NextURL for index = ${l} (isLast = ${m}): ${i.nextURL||"No Next URL"}`),a.features.push(...i.features),m&&(a.numberMatched=i.numberMatched,a.nextURL=i.nextURL)});return await Promise.all(u),a}var d,U,y,S,v,G,M,D;class bt{constructor(t,r){p(this,v);p(this,M);A(this,"label");p(this,d,void 0);p(this,U,void 0);p(this,y,void 0);p(this,S,void 0);this.label=t.label,w(this,d,t),w(this,U,r);const{baseUrl:s,params:o}=Rt(t.baseUrl);w(this,y,s),w(this,S,o)}async search(t,{mapProjection:r,maxResults:s,signal:o}){const c=O(this,M,D).call(this,t,s),a=new N({dataProjection:"EPSG:4326",featureProjection:r});return(await wt(f(this,U),c,o)).features.map(n=>O(this,v,G).call(this,n,a))}}d=new WeakMap,U=new WeakMap,y=new WeakMap,S=new WeakMap,v=new WeakSet,G=function(t,r){const s=f(this,d).renderLabel?.(t),o=t.properties[f(this,d).labelProperty],c=t.properties[f(this,d).searchProperty],a=(()=>s||(o!==void 0?String(o):c!==void 0?String(c):""))();return{id:t.id??tt(),label:a,geometry:r.readGeometry(t.geometry),properties:t.properties}},M=new WeakSet,D=function(t,r){const s=new URL(`${f(this,y)}/collections/${f(this,d).collectionId}/items`);for(const[o,c]of f(this,S))s.searchParams.append(o,c);return s.searchParams.set(f(this,d).searchProperty,`*${t}*`),s.searchParams.set("limit",String(r)),s.searchParams.set("f","json"),f(this,d).rewriteUrl?.(new URL(s))??s};async function wt(e,t,r){try{const s=await e.fetch(t,{signal:r,headers:{Accept:"application/json"}});if(!s.ok)throw new Error("Request failed with status "+s.status);return await s.json()}catch(s){throw q(s)?s:new Error("Failed to search on OGC API Features service",{cause:s})}}function Rt(e){const t=new URL(e),r=new URLSearchParams(t.searchParams);return t.search="",{baseUrl:t.href.replace(/\/+$/,""),params:r}}var P;class Mt{constructor({references:t}){p(this,P,void 0);w(this,P,t.httpService)}createVectorSource(t){return ht(t,f(this,P))}}P=new WeakMap;var I;class jt{constructor({references:t}){p(this,I,void 0);w(this,I,t.httpService)}createSearchSource(t){return new bt(t,f(this,I))}}I=new WeakMap;const xt="@open-pioneer/map-navigation",T=at.bind(void 0,xt),Et=j.forwardRef(function(t,r){const{mapId:s}=t,{containerProps:o}=$("initial-extent",t),{map:c}=z(s),a=T();function u(){const n=c?.initialExtent,l=c?.olMap;if(n&&l){const m=[n.xMin,n.yMin,n.xMax,n.yMax];l.getView().fit(m,{duration:200})}}return R.jsx(k,{ref:r,label:a.formatMessage({id:"initial-extent.title"}),icon:R.jsx(rt,{}),onClick:u,...o})}),Ct=j.forwardRef(function(t,r){return R.jsx(B,{zoomDirection:"in",ref:r,...t})}),Ot=j.forwardRef(function(t,r){return R.jsx(B,{zoomDirection:"out",ref:r,...t})}),B=j.forwardRef(function(t,r){const{mapId:s,zoomDirection:o}=t,{map:c}=z(s),a=T(),{defaultClassName:u,buttonLabel:n,buttonIcon:l}=Ft(a,o),{containerProps:m}=$(et("zoom",u),t);function i(){const h=c?.olMap.getView();let g=h?.getZoom();h&&g!==void 0&&(o==="in"?++g:--g,h.animate({zoom:g,duration:200}))}return R.jsx(k,{ref:r,label:n,icon:l,onClick:i,...m})});function Ft(e,t){switch(t){case"in":return{defaultClassName:"zoom-in",buttonLabel:e.formatMessage({id:"zoom-in.title"}),buttonIcon:R.jsx(ot,{})};case"out":return{defaultClassName:"zoom-out",buttonLabel:e.formatMessage({id:"zoom-out.title"}),buttonIcon:R.jsx(st,{})}}}export{Et as I,jt as S,Mt as V,Ct as Z,Ot as a};
